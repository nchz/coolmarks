{% extends "base.html" %}

{% block html_head %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

<script>

  function findCheckedRows() {
    var result = [];
    $("table > tbody input[type='checkbox']:checked").each((i, elem) => {
      result.push(elem.id);
    });
    return result;
  }

  $(document).ready(function () {
    $(".-links-form").submit(function () {
      const checkedRows = findCheckedRows();
      $("<input />")
        .attr("type", "hidden")
        .attr("name", "link_ids")
        .attr("value", checkedRows.join(","))
        .appendTo(this);
      return true;
    });
  });

  $(document).ready(function () {
    $(".-links-form-button").click(function () {
      $("<input />")
        .attr("type", "hidden")
        .attr("name", "action")
        .attr("value", this.id.substring(5))
        .appendTo(this.parentElement);
    });
  });

  $(document).ready(function () {
    $("#select-all").click(function () {
      $("table > tbody input[type='checkbox']:not(:checked)").click();
    })
  });

  $(document).ready(function () {
    $("#select-none").click(function () {
      $("table > tbody input[type='checkbox']:checked").click();
    })
  });

  function selectRow(elem) {
    // highlight row.
    elem.parentElement.parentElement.classList.toggle("table-active");

    // toggle visibility of panels if necessary.
    const panelAdd = document.getElementById("panel-add");
    const panelEdit = document.getElementById("panel-edit");

    if (findCheckedRows().length == 0) {
      panelAdd.classList.remove("d-none");
      panelEdit.classList.add("d-none");
    } else {
      // TODO extract tags from selected links and set input.value.
      panelAdd.classList.add("d-none");
      panelEdit.classList.remove("d-none");
    }
  }

  $(document).ready(function () {
    console.log("aloha!");
  });

</script>

{% endblock %}

{% block body_main %}

<div id="top-panel" class="d-flex m-2">

  <div id="panel-select" style="width: 150;">
    <h6 class="mx-2 mt-1 mb-0">Select</h6>
    <div class="d-flex">
      <button id="select-all" class="col m-1 btn btn-secondary">All</button>
      <button id="select-none" class="col m-1 btn btn-secondary">None</button>
    </div>
  </div>

  <div class="vr m-2"></div>

  <!-- Either "panel-add" or "panel-edit" is visible (depending on selected rows), never both at the same time. -->

  <div id="panel-add" class="col">
    <h6 class="mx-2 mt-1 mb-0">Add Link</h6>
    <form action="{% url 'links:list' %}" method="POST" class="d-flex">
      {% csrf_token %}
      <button type="submit" class="m-1 btn btn-success">+</button>
      {% with link_list|first as first %}
      <input type="text" name="_tags_string" placeholder="tags; separated; by ;" value="{{ first.tags_string }}"
        class="col m-1 form-control">
      {% endwith %}
      <input required type="url" name="location" placeholder="http://example.com" class="w-75 m-1 form-control">
    </form>
  </div>

  <div id="panel-edit" class="d-none col">
    <h6 class="mx-2 mt-1 mb-0">Edit Tags</h6>
    <div class="d-flex">
      <form id="edit-tags-form" action="{% url 'links:edit' %}" method="POST" class="-links-form d-flex col">
        {% csrf_token %}
        <button type="submit" class="-links-form-button m-1 btn btn-warning" id="tags-set">Set</button>
        <button type="submit" class="-links-form-button m-1 btn btn-warning" id="tags-add">Add</button>
        <button type="submit" class="-links-form-button m-1 btn btn-warning" id="tags-remove">Remove</button>
        {% with link_list|first as first %}
        <input type="text" name="_tags_string" placeholder="tags; separated; by ;" value="{{ first.tags_string }}"
          class="col m-1 form-control">
        {% endwith %}
      </form>
      <div class="vr mx-2"></div>
      <form id="delete-links-form" action="{% url 'links:delete' %}" method="POST" class="-links-form">
        {% csrf_token %}
        <button type="submit" class="m-1 btn btn-danger">Delete Links</button>
      </form>
    </div>
  </div>

</div>

<table id="links-table" class="table table-hover">
  <thead>
    <tr>
      <th></th>
      <th>Date added</th>
      <th>Title</th>
      <th>Domain</th>
      <th>Tags</th>
    </tr>
  </thead>
  <tbody>
    {% for link in link_list %}
    <tr>
      <td style="width: 0;">
        <input id="{{ link.id }}" type="checkbox" onchange="selectRow(this)">
      </td>
      <td onclick="$('input#{{ link.id }}').click()">
        {{ link.dt | slice:":19" }}
      </td>
      <td><a href="{{ link.location }}" target="_blank">{{ link.title }}</a></td>
      <td>{{ link.domain }}</td>
      <td>
        {% for tag in link.tags.all %}
        <span class="my-1 badge rounded-pill bg-primary">
          {{ tag.name }}<span style="font-size: 0;">;</span>
        </span>
        {% endfor %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}